# Semantic Gaussians: Scene Graph Instance Segmentation

This document provides a comprehensive guide for generating and visualizing **Scene Graph Nodes (Object Instances)** from fused Semantic Gaussians.

The pipeline post-processes the fused 3D point cloud using **DBSCAN clustering** to segment individual object instances (e.g., separating distinct chairs) and prepares the data for Scene Graph generation.

---

## Pipeline Overview

The process consists of two main stages:

1. **Generation (`generate_scenegraph.py`)**
   - Filters the 3D Gaussian point cloud by target semantic labels.
   - Applies spatial clustering (DBSCAN) to identify distinct object instances.
   - Exports instance metadata (JSON) and per-point instance IDs (NPY).

2. **Visualization (`view_instances.py`)**
   - Renders the 3D point cloud colored by instance IDs.
   - Allows visual verification of the segmentation quality via a web viewer.

---

## Prerequisites

### Environment Setup

Ensure you are running in the main project environment (e.g., `sega`). Install required dependencies:

```bash
pip install viser scikit-learn
```

### Required Files

Ensure the following files are present in your workspace:

- **Scripts**:  
  `generate_scenegraph.py`, `view_instances.py` (located in project root)

- **Weights**:  
  LSeg checkpoint at `weights/lseg/demo_e200.ckpt`

- **Data**:  
  - Geometry: Trained Gaussian Splatting model (e.g., `point_cloud.ply` from `iteration_7000`)
  - Semantics: Fused feature file (e.g., `0.pt` generated by `fusion.py`)

---

## Usage Guide

### Step 1: Generate Scene Graph Nodes

Run the generation script to perform clustering and extract object nodes:

```bash
python generate_scenegraph.py \
    --ply_path "/path/to/your/output/point_cloud/iteration_7000/point_cloud.ply" \
    --fusion_path "/path/to/your/output/fusion/0.pt"
```

**What happens inside?**

- **Label Filtering**: Only processes classes defined in the `LABELS` list to focus on major objects and reduce noise.  
- **Downsampling**: If a class exceeds `MAX_POINTS_PER_CLASS` (default: 200k), it randomly downsamples points to prevent memory errors.  
- **Clustering**: Applies DBSCAN to group points spatially.  
- **Pruning**: Removes small clusters (default < 2000 points) to clean up noise.

**Outputs**

- `scene_graph_nodes.json`: Metadata for each instance (ID, label, bounding box, centroid)  
- `instance_ids.npy`: Numpy array mapping each point to an instance ID

---

### Step 2: Visualize Instances

Verify the quality of the generated instances using the interactive Viser viewer:

```bash
python view_instances.py \
    --ply_path "/path/to/your/output/point_cloud/iteration_7000/point_cloud.ply" \
    --npy_path "instance_ids.npy"
```

**How to Inspect**

- Click the local URL displayed in the terminal (e.g., `http://localhost:8080`)
- **Colored Points**: Represent valid object instances  
- **Grey Points**: Represent background (e.g., wall/floor) or filtered noise  
- Visually check if objects are correctly separated or if they appear merged/fragmented

---

## Tuning Guide

If the segmentation results are not satisfactory, adjust parameters within `generate_scenegraph.py`:

| Parameter                | Default | Description |
|-------------------------|---------|-------------|
| `eps`                   | 0.1     | DBSCAN neighbor distance (meters) |
| `min_samples`           | 100     | Minimum points to form a cluster |
| `LABELS`                | List    | Target semantic labels |
| `post_filtering`        | 2000    | Minimum points for a valid instance |

**Adjustment Strategy**

- Increase `eps` (e.g., `0.2`) if objects are split into parts  
- Decrease `eps` (e.g., `0.05`) if distinct objects are being merged  
- Increase `min_samples` to reduce noise  
- Decrease `min_samples` to preserve smaller valid objects  

---

## Troubleshooting

### FileNotFoundError

Ensure you provide absolute paths for `--ply_path` and `--fusion_path`.

### RuntimeError: CUDA out of memory

The clustering runs on CPU, but loading the `.pt` file may require large system RAM. Ensure sufficient system memory. If needed, decrease `MAX_POINTS_PER_CLASS` in the script.

### Viser connection issues

If running on a remote server, forward the port:

```bash
ssh -L 8080:localhost:8080 user@server
```

---

## Example

To generate and visualize scene graph nodes:

1. Generate:
    ```bash
    python generate_scenegraph.py \
        --ply_path "/data/output/pc/point_cloud.ply" \
        --fusion_path "/data/output/fusion/0.pt"
    ```

2. Visualize:
    ```bash
    python view_instances.py \
        --ply_path "/data/output/pc/point_cloud.ply" \
        --npy_path "instance_ids.npy"
    ```
